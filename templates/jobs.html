{% extends 'base.html' %}

{% block title %}Registrerade jobb{% endblock %}

{% block content %}

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash">
        {{ messages[0] }}
    </div>
  {% endif %}
{% endwith %}

<div class="container">
    <h1>Registrerade jobb</h1>

    <div class="print-btn-wrapper">
  <a href="{{ url_for('generate_job_list_pdf', sort=sort, sort_field=sort_field) }}" class="btn-pdf">
    üñ®Ô∏è Skriv ut
  </a>
</div>

    <label for="sort">Sortera datum:</label>
        <select name="sort" onchange="this.form.submit()">
            <option value="desc" {% if sort == 'desc' %}selected{% endif %}>Nyast f√∂rst</option>
            <option value="asc" {% if sort == 'asc' %}selected{% endif %}>√Ñldst f√∂rst</option>
        </select>

    <input type="text" id="liveSearch" placeholder="S√∂k kundnamn eller registreringsnummer..." style="width: 100%; padding: 10px; margin-bottom: 15px; font-size: 14px;">

    <form method="get" action="/jobs" class="search-form">
        <input type="hidden" name="search" value="{{ search }}">

        
    </form>

    


    <table>
        <thead>
            <tr>
                <th>
                    <a href="{{ url_for('jobs', sort_field='date', sort='asc' if sort_field != 'date' or sort == 'desc' else 'desc', search=search) }}">
                        Datum {% if sort_field == 'date' %}{{ '‚Üë' if sort == 'asc' else '‚Üì' }}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('jobs', sort_field='name', sort='asc' if sort_field != 'name' or sort == 'desc' else 'desc', search=search) }}">
                        Kund {% if sort_field == 'name' %}{{ '‚Üë' if sort == 'asc' else '‚Üì' }}{% endif %}
                    </a>
                </th>
                <th>Telefon</th>
                <th>Bil</th>
                <th>Reg.nr</th>
                <th>Tj√§nst</th>
                <th>Pris</th>
                <th>Status</th>
                <th>√Ötg√§rd</th>
                <th>Radera</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr class="{% if job[8] == 'Fakturerad' %}fakturerad{% endif %}">
                <td>{{ job[7] }}</td>
                <td>{{ job[1] }}</td>
                <td>{{ job[2] }}</td>
                <td>{{ job[3] }}</td>
                <td>{{ job[4] }}</td>
                <td>{{ job[5] }}</td>
                <td>{{ job[6] }}</td>
                <td>
                    {% if job[8] == 'Fakturerad' %}
                        ‚úî Fakturerad
                    {% else %}
                        ‚ùå Ej fakturerad
                    {% endif %}
                </td>
                <td>
                    <form method="post" action="/toggle_status/{{ job[0] }}" onsubmit="return confirmToggleStatus(this)">
                        <input type="hidden" name="pin">
                        <button type="submit" class="action-btn">
                            {% if job[8] == 'Fakturerad' %}
                                √Öngra fakturering
                            {% else %}
                                Markera som fakturerad
                            {% endif %}
                        </button>
                    </form>
                </td>
                <td>
                    <form method="post" action="/delete/{{ job[0] }}" onsubmit="return confirmDelete(this)">
                        <input type="hidden" name="pin">
                        <button type="submit">üóëÔ∏è Ta bort</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a class="link" href="/">Tillbaka</a>
</div>

<script>
  setTimeout(function () {
    var flash = document.querySelector('.flash');
    if (flash) {
      flash.style.transition = 'opacity 0.5s ease';
      flash.style.opacity = '0';
      setTimeout(function () {
        flash.remove();
      }, 500);
    }
  }, 3000);
</script>

<script>
function confirmDelete(form) {
    const pin = prompt("Ange PIN-kod f√∂r att radera:");
    if (pin === null || pin.trim() === "") return false;
    form.pin.value = pin;
    return true;
}
</script>

<script>
document.getElementById('liveSearch').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
        const name = row.cells[1]?.innerText.toLowerCase();
        const reg = row.cells[4]?.innerText.toLowerCase();

        if (name.includes(filter) || reg.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});
</script>

<script>
function confirmToggleStatus(form) {
    const pin = prompt("Ange PIN-kod f√∂r att bekr√§fta:");
    if (pin === null) return false;
    form.pin.value = pin;
    return true;
}
</script>

{% endblock %}
