{% extends 'base.html' %}

{% block title %}Registrerade jobb{% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash">{{ messages[0] }}</div>
  {% endif %}
{% endwith %}

<div class="container">
  <h1>Registrerade jobb</h1>

  <div class="print-btn-wrapper">
    <a href="{{ url_for('generate_job_list_pdf', sort=sort, sort_field=sort_field) }}" class="btn-pdf">üñ®Ô∏è Skriv ut</a>
  </div>

  <label for="sort">Sortera datum:</label>
  <select name="sort" onchange="this.form.submit()">
    <option value="desc" {% if sort == 'desc' %}selected{% endif %}>Nyast f√∂rst</option>
    <option value="asc" {% if sort == 'asc' %}selected{% endif %}>√Ñldst f√∂rst</option>
  </select>

  <input type="text" id="liveSearch" placeholder="S√∂k kundnamn eller registreringsnummer..." style="width: 100%; padding: 10px; margin-bottom: 15px; font-size: 14px;">

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Kund</th>
        <th>Telefon</th>
        <th>Bil</th>
        <th>Reg.nr</th>
        <th>Tj√§nst</th>
        <th>Pris</th>
        <th>Status</th>
        <th>√Ötg√§rder</th>
        <th>Radera</th>
      </tr>
    </thead>
    <tbody>
      {% for job in jobs %}
      <tr id="row-{{ job[0] }}" class="{% if job[8] == 'Fakturerad' %}fakturerad{% endif %}">
        {% if request.args.get('edit') == job[0]|string %}
        <form method="post" action="/update/{{ job[0] }}">
          <td>{{ job[7] }}</td>
          <td><input name="customer_name" value="{{ job[1] }}"></td>
          <td><input name="phone" value="{{ job[2] }}"></td>
          <td><input name="car_model" value="{{ job[3] }}"></td>
          <td><input name="license_plate" value="{{ job[4] }}"></td>
          <td><input name="service" value="{{ job[5] }}"></td>
          <td><input name="price" value="{{ job[6] }}"></td>
          <td>{{ job[8] }}</td>
          <td colspan="2">
            <button type="submit">üíæ Spara</button>
            <a href="/jobs" style="margin-left: 10px;">Avbryt</a>
          </td>
        </form>
        {% else %}
        <td>{{ job[7] }}</td>
        <td>{{ job[1] }}</td>
        <td>{{ job[2] }}</td>
        <td>{{ job[3] }}</td>
        <td>{{ job[4] }}</td>
        <td>{{ job[5] }}</td>
        <td>{{ job[6] }}</td>
        <td>{% if job[8] == 'Fakturerad' %}‚úî{% else %}‚ùå{% endif %} {{ job[8] }}</td>
        <td>
          <form method="post" action="/toggle_status/{{ job[0] }}" onsubmit="return confirmToggleStatus(this)">
            <input type="hidden" name="pin">
            <button type="submit" class="action-btn">
              {% if job[8] == 'Fakturerad' %}√Öngra fakturering{% else %}Markera som fakturerad{% endif %}
            </button>
          </form>
          <a href="/jobs?edit={{ job[0] }}" class="action-btn">‚úèÔ∏è Redigera</a>
        </td>
        <td>
          <form method="post" action="/delete/{{ job[0] }}" onsubmit="return confirmDelete(this)">
            <input type="hidden" name="pin">
            <button type="submit">üóëÔ∏è Ta bort</button>
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a class="link" href="/">Tillbaka</a>
</div>

<script>
setTimeout(() => {
  const flash = document.querySelector('.flash');
  if (flash) {
    flash.style.transition = 'opacity 0.5s ease';
    flash.style.opacity = '0';
    setTimeout(() => flash.remove(), 500);
  }
}, 3000);

function confirmDelete(form) {
  const pin = prompt("Ange PIN-kod f√∂r att radera:");
  if (!pin) return false;
  form.pin.value = pin;
  return true;
}

function confirmToggleStatus(form) {
  const pin = prompt("Ange PIN-kod f√∂r att bekr√§fta:");
  if (pin === null) return false;
  form.pin.value = pin;
  return true;
}

document.getElementById('liveSearch').addEventListener('input', function () {
  const filter = this.value.toLowerCase();
  document.querySelectorAll("table tbody tr").forEach(row => {
    const name = row.cells[1]?.innerText.toLowerCase();
    const reg = row.cells[4]?.innerText.toLowerCase();
    row.style.display = name.includes(filter) || reg.includes(filter) ? "" : "none";
  });
});
</script>
{% endblock %}