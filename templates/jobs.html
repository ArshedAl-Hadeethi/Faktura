{% extends 'base.html' %}

{% block title %}Registrerade jobb{% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash">{{ messages[0] }}</div>
  {% endif %}
{% endwith %}

<div class="container">
  <h1>Registrerade jobb</h1>

  <div class="print-btn-wrapper">
    <a href="{{ url_for('generate_job_list_pdf', sort=sort, sort_field=sort_field) }}" class="btn-pdf">
      üñ®Ô∏è Skriv ut
    </a>
  </div>

  <label for="sort">Sortera datum:</label>
  <select name="sort" onchange="this.form.submit()">
    <option value="desc" {% if sort == 'desc' %}selected{% endif %}>Nyast f√∂rst</option>
    <option value="asc" {% if sort == 'asc' %}selected{% endif %}>√Ñldst f√∂rst</option>
  </select>

  <input type="text" id="liveSearch" placeholder="S√∂k kundnamn eller registreringsnummer..." style="width: 100%; padding: 10px; margin-bottom: 15px; font-size: 14px;">

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Kund</th>
        <th>Telefon</th>
        <th>Bil</th>
        <th>Reg.nr</th>
        <th>Tj√§nst</th>
        <th>Pris</th>
        <th>Status</th>
        <th>√Ötg√§rd</th>
        <th>Radera</th>
      </tr>
    </thead>
    <tbody>
      {% for job in jobs %}
      <tr id="row-{{ job[0] }}">
        <td>{{ job[7] }}</td>
        <td id="name-{{ job[0] }}">{{ job[1] }}</td>
        <td id="phone-{{ job[0] }}">{{ job[2] }}</td>
        <td id="car-{{ job[0] }}">{{ job[3] }}</td>
        <td id="reg-{{ job[0] }}">{{ job[4] }}</td>
        <td id="service-{{ job[0] }}">{{ job[5] }}</td>
        <td id="price-{{ job[0] }}">{{ job[6] }}</td>
        <td>
          {% if job[8] == 'Fakturerad' %}
            ‚úî Fakturerad
          {% else %}
            ‚ùå Ej fakturerad
          {% endif %}
        </td>
        <td>
          <form method="post" action="/toggle_status/{{ job[0] }}" onsubmit="return confirmToggleStatus(this)" style="display:inline;">
            <input type="hidden" name="pin">
            <button type="submit" class="action-btn small">
              {% if job[8] == 'Fakturerad' %}√Öngra{% else %}Fakturera{% endif %}
            </button>
          </form>
          <button class="edit-btn small" onclick="toggleEdit({{ job[0] }})">‚úèÔ∏è Redigera</button>
        </td>
        <td>
          <form method="post" action="/delete/{{ job[0] }}" onsubmit="return confirmDelete(this)">
            <input type="hidden" name="pin">
            <button type="submit" class="danger small">üóëÔ∏è</button>
          </form>
        </td>
      </tr>

      <!-- Redigeringsrad (dold som standard) -->
      <tr id="edit-row-{{ job[0] }}" style="display: none; background-color: #f3f3f3;">
        <form method="post" action="/edit/{{ job[0] }}">
          <td></td>
          <td><input type="text" name="customer_name" value="{{ job[1] }}"></td>
          <td><input type="text" name="phone" value="{{ job[2] }}"></td>
          <td><input type="text" name="car_model" value="{{ job[3] }}"></td>
          <td><input type="text" name="license_plate" value="{{ job[4] }}"></td>
          <td><input type="text" name="service" value="{{ job[5] }}"></td>
          <td><input type="number" step="0.01" name="price" value="{{ job[6] }}"></td>
          <td colspan="2">
            <button type="submit" class="btn-save">üíæ Spara</button>
            <button type="button" onclick="toggleEdit({{ job[0] }})" class="btn-cancel">Avbryt</button>
          </td>
          <td></td>
        </form>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a class="link" href="/">Tillbaka</a>
</div>

<script>
function confirmDelete(form) {
  const pin = prompt("Ange PIN-kod f√∂r att radera:");
  if (pin === null || pin.trim() === "") return false;
  form.pin.value = pin;
  return true;
}

function confirmToggleStatus(form) {
  const pin = prompt("Ange PIN-kod f√∂r att bekr√§fta:");
  if (pin === null) return false;
  form.pin.value = pin;
  return true;
}

function toggleEdit(id) {
  const editRow = document.getElementById("edit-row-" + id);
  editRow.style.display = editRow.style.display === "none" ? "" : "none";
}

document.getElementById('liveSearch').addEventListener('input', function () {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("table tbody tr:not([id^='edit-row'])");
  rows.forEach(row => {
    const name = row.cells[1]?.innerText.toLowerCase();
    const reg = row.cells[4]?.innerText.toLowerCase();
    if (name.includes(filter) || reg.includes(filter)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});
</script>

<style>
.small {
  font-size: 0.8rem;
  padding: 5px 10px;
}
.btn-save {
  background-color: #4CAF50;
  color: white;
  padding: 5px 10px;
}
.btn-cancel {
  background-color: #ccc;
  padding: 5px 10px;
}
.edit-btn {
  background-color: #03a9f4;
  color: white;
  border: none;
  padding: 5px 10px;
  margin-left: 5px;
}
.danger {
  background-color: #f44336;
  color: white;
  padding: 5px 10px;
}
</style>

{% endblock %}
